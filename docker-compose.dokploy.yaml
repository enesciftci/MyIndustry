version: '3.8'

# ===================
# MyIndustry Application Services for Dokploy
# ===================
# Infrastructure (PostgreSQL, Redis) uses Dokploy built-in services
# RabbitMQ runs as separate Dokploy compose
#
# Required Environment Variables (set in Dokploy UI):
# - DB_HOST, DB_PASSWORD
# - REDIS_HOST, REDIS_PASSWORD
# - RABBITMQ_HOST, RABBITMQ_USER, RABBITMQ_PASSWORD

services:
  myindustry-api:
    build:
      context: .
      dockerfile: MyIndustry.Api/Dockerfile
    container_name: myindustry-api
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__MyIndustry: Host=${DB_HOST};Port=5432;Database=myindustry;Username=postgres;Password=${DB_PASSWORD}
      IdentityUrl: http://myindustry-identity:8080
    ports:
      - "5000:8080"
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  myindustry-identity:
    build:
      context: .
      dockerfile: MyIndustry.Identity.Api/Dockerfile
    container_name: myindustry-identity
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__MyIndustryIdentityDb: Host=${DB_HOST};Port=5432;Database=myindustry_identity;Username=postgres;Password=${DB_PASSWORD}
      ConnectionStrings__Redis: ${REDIS_HOST}:6379,password=${REDIS_PASSWORD}
      IdentityUrl: http://myindustry-identity:8080
      RabbitMq__Host: ${RABBITMQ_HOST}
      RabbitMq__Port: "5672"
      RabbitMq__UserName: ${RABBITMQ_USER}
      RabbitMq__Password: ${RABBITMQ_PASSWORD}
    ports:
      - "5001:8080"
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  myindustry-gateway:
    build:
      context: .
      dockerfile: MyIndustry.Gateway/Dockerfile
    container_name: myindustry-gateway
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
    ports:
      - "5002:8080"
    networks:
      - dokploy-network
    depends_on:
      - myindustry-api
      - myindustry-identity

  myindustry-queue:
    build:
      context: .
      dockerfile: MyIndustry.Queue/Dockerfile
    container_name: myindustry-queue
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__MyIndustry: Host=${DB_HOST};Port=5432;Database=myindustry;Username=postgres;Password=${DB_PASSWORD}
      RabbitMq__Host: ${RABBITMQ_HOST}
      RabbitMq__Port: "5672"
      RabbitMq__UserName: ${RABBITMQ_USER}
      RabbitMq__Password: ${RABBITMQ_PASSWORD}
    networks:
      - dokploy-network

# ===================
# Network
# ===================
networks:
  dokploy-network:
    external: true
    name: dokploy-network
